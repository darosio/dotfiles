[[mgr.prepend_keymap]]
on = ["g", "S"]
run = 'search --via=rga'
desc = "Search (rga)"

[[mgr.prepend_keymap]]
on = ["g", "s"]
run = 'search_do --via=fd --args="-tf -d3"'
desc = "Search flat view 3"

[[mgr.prepend_keymap]]
on = [",", ","]
run = ["sort mtime --reverse"]
desc = "Sort by modified time (reverse)"

# Go to Places
[[mgr.prepend_keymap]]
on = ["g", "d"]
run = "cd /home/dati/"
desc = "Go /home/dati"

[[mgr.prepend_keymap]]
on = ["g", "p"]
run = "cd ~/Sync/tmp/PrtSc/"
desc = "Go ~/Sync/tmp/PrtSc"

[[mgr.prepend_keymap]]
on = ["g", "b"]
run = "cd ~/Sync/box/"
desc = "Go ~/Sync/box"

[[mgr.prepend_keymap]]
on = ["g", "n"]
run = "cd ~/Sync/notes"
desc = "Go ~/Sync/notes"

[[mgr.prepend_keymap]]
on = ["g", "w"]
run = "cd ~/workspace"
desc = "Go ~/workspace"

[[mgr.prepend_keymap]]
on = ["g", "r"]
run = 'shell -- ya emit cd "$(git rev-parse --show-toplevel)"'
desc = "Go back to git root"

[[mgr.prepend_keymap]]
on = "q"
for = "unix"
run = 'shell "$SHELL" --block'
desc = "Open $SHELL here"

# Copy selected files to the system clipboard while yanking
[[mgr.prepend_keymap]]
on = "Y"
run = ['shell -- for path in "$@"; do echo "file://$path"; done | wl-copy -t text/uri-list', "yank"]

# smart-paste without entering destination folder
[[mgr.prepend_keymap]]
on = "p"
run = "plugin smart-paste"
desc = "Paste into the hovered directory or CWD"

[[mgr.prepend_keymap]]
on = "t"
run = "plugin smart-tab"
desc = "Create a tab and enter the hovered directory"

# Confirm before quitting if multiple tabs are open
[[mgr.prepend_keymap]]
on = "Q"
run = "plugin confirm-quit"

# Hide/Show preview:
[[mgr.prepend_keymap]]
on = "\\"
run = "plugin toggle-pane min-preview"
desc = "Show or hide the preview pane"

# Maximize/Restore preview:
[[mgr.prepend_keymap]]
on = "|"
run = "plugin toggle-pane max-preview"
desc = "Maximize or restore the preview pane"

[[mgr.prepend_keymap]]
on = ["C"]
run = "plugin ouch"
desc = "Compress with ouch"

# [[mgr.prepend_keymap]]
# on = ["<A-TAB>"]
# run = "shell -- git annex info --bytes --fast $@| awk '/local annex size/ {print $4/1024/1024}' | xargs zenity --info --text"
# desc = "Show Git-Annex total size"

# [[mgr.prepend_keymap]]
# on = ["<A-TAB>"]
# run = "shell -- bash -c 'size=$(git annex info --bytes --fast 2>/dev/null | awk \"/local annex size/ {print \\$4/1024/1024}\"); if [ -n \"$size\" ]; then zenity --progress --text=\"Git Annex Size: ${size} MB\" --percentage=100 --auto-close; else zenity --error --text=\"Not in a git annex repository\"; fi'"
# desc = "Show Git-Annex total size with progress bar"
# [[mgr.prepend_keymap]]
# on = ["<A-TAB>"]
# run = "shell -- { GIT_OUTPUT=$(git annex info --bytes --fast $@ 2>/dev/null); SIZE_MIB=$(echo \"$GIT_OUTPUT\" | awk '/local annex size/ {printf \"%.2f MiB\", $4/1024/1024}'); zenity --info --title='Git-Annex Total Size' --text=\"Total annexed size: $SIZE_MIB\"; } || zenity --error --title='Git-Annex Error' --text='Not a valid Git Annex repository or command failed.' "
# desc = "Show Git-Annex total size (MiB)"
# [[mgr.prepend_keymap]]
# on = ["<A-TAB>"]
# run = '''
# shell -- bash -c '
# size=$(git annex info --bytes --fast 2>/dev/null |
#         awk -F: "/local annex size/ {gsub(/ /, \"\", \$2); print \$2/1024/1024}") &&
# if [ -n "$size" ]; then
#     zenity --info --title="Git Annex Info" \
#            --text="ðŸ“¦ Annex size: $(printf "%.2f" "$size") MB" \
#            --width=300
# else
#     zenity --warning --title="Git Annex Info" \
#            --text="No annexed content found or not a git-annex repo."
# fi'
# '''
# desc = "Show Git-Annex total size"
# [[mgr.prepend_keymap]]
# on = ["<A-TAB>"]
# run = "shell -- git annex info --fast --bytes . |
#        awk '/local annex size:/{size=$5} END{
#          if(!size) exit 1
#          split(\"Ki Mi Gi Ti\",u)
#          for(i=1;i<=4;i++){ if(size<1024^(i+1)){ printf \"%.2f %sB\",size/1024^i,u[i]; exit }}
#          printf \"%.2f B\",size
#        }' |
#        xargs -I{} zenity --info --width=340 --title='Git-Annex Total' --text='Total annexed data in this repo:\n\n<b>{}</b>' --html"
# desc = "Pop-up Git-Annex total size (human + bold)"
[[mgr.prepend_keymap]]
on = ["<A-TAB>"]
run = '''shell --
{
  # 1. Run git annex info, suppress errors, capture output
  GIT_OUTPUT=$(git annex info --bytes --fast "$@" 2>/dev/null);

  # 2. Extract the byte size and convert it to human-readable format (e.g., 2.2G)
  #    `numfmt` is the standard GNU tool for this and is more reliable than awk/printf for unit conversion.
  SIZE_BYTES=$(echo "$GIT_OUTPUT" | awk '/local annex size/ {print $4}');
  HUMAN_SIZE=$(echo "$SIZE_BYTES" | numfmt --to=iec --suffix=B);

  # 3. Check for a valid size and display the result via Zenity
  if [[ -z "$SIZE_BYTES" || "$SIZE_BYTES" == "0" ]]; then
    zenity --warning --title="Git-Annex Info" --text="Not a Git-Annex repository, or no annexed content found."
  else
    zenity --info --title="Git-Annex Total Size" --text="Total annexed size: \n${HUMAN_SIZE}"
  fi
}'''
desc = "Show Git-Annex total size (Human Readable)"

# email selected files
[[mgr.prepend_keymap]]
on = "<C-m>"
run = '''shell --block --
    # 1. Collect all selected paths, separated by a comma.
    #    We use printf "%s," to ensure no trailing newline, and sed to remove the final comma.
    paths=$(for p in "$@"; do printf "%s," "$p"; done | sed 's/,$//')

    # 2. ESCAPE the collected paths for embedding into the Lisp string.
    #    This is crucial for paths containing spaces, backslashes, or quotes.
    elisp_paths=$(printf "%s" "$paths" | sed 's/\\/\\\\\\\\/g; s/"/\\"/g')

    # 3. Execute the working command via emacsclient, ensuring it creates a new frame (-c)
    #    and doesn't block the terminal (until the frame is closed) (-n).
    emacsclient -c -n -e "(mu4e-compose-new-with-attachments \"$elisp_paths\")"
'''
desc = "Compose mu4e message with selected file attachments"

[[input.prepend_keymap]]
on = "<C-g>"
run = "close"
desc = "Cancel input"
