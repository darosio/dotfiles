
name: Emacs CI

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'emacs/**'
      # schedule:
      #   - cron: '0 5 * * 1'  # every Monday at 05:00 UTC

jobs:

  smoke-tests:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    env:
      CI: true
    steps:
      - uses: actions/checkout@v6
      - name: Prepare Emacs configuration directory
        run: |
          mkdir -p ~/Sync/proj ~/Sync/box/org/gcal ~/Sync/notes/arch
          mkdir -p ~/Sync/notes/org-roam ~/Sync/biblio ~/Sync/media
          ln -s "$GITHUB_WORKSPACE/emacs/.emacs.d" ~/.emacs.d
      - name: Set up Emacs
        uses: purcell/setup-emacs@master
        with:
          version: 30.1
      - name: Cache Straight.el
        uses: actions/cache@v5
        with:
          path: |
            ~/.emacs.d/straight
            ~/.emacs.d/build
          key: ${{ runner.os }}-straight-${{ hashFiles('emacs/.emacs.d/straight/versions/default.el') }}
          restore-keys: |
            ${{ runner.os }}-straight-
      - name: Run Emacs smoke tests
        run: make test-emacs

  update-packages:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    env:
      CI: true
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          persist-credentials: false
      - name: Prepare Emacs configuration directory
        run: |
          mkdir -p ~/Sync/proj ~/Sync/box/org/gcal ~/Sync/notes/arch
          mkdir -p ~/Sync/notes/org-roam ~/Sync/biblio ~/Sync/media
          ln -s "$GITHUB_WORKSPACE/emacs/.emacs.d" ~/.emacs.d
      - name: Set up Emacs
        uses: purcell/setup-emacs@master
        with:
          version: 30.1
      - name: Cache Straight.el
        uses: actions/cache@v5
        with:
          path: |
            ~/.emacs.d/straight
            ~/.emacs.d/build
          key: ${{ runner.os }}-straight-${{ hashFiles('emacs/.emacs.d/straight/versions/default.el') }}
          restore-keys: |
            ${{ runner.os }}-straight-

      - name: Update packages and run smoke tests
        run: make upgrade-emacs

      - name: Create PR if versions changed
        env:
          GH_TOKEN: ${{ secrets.PAT_WORKFLOWS }}
        run: |
          VERSIONS_FILE="emacs/.emacs.d/straight/versions/default.el"
          if git diff --quiet "$VERSIONS_FILE"; then
            echo "No version changes to commit."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          gh auth setup-git
          BRANCH="chore/update-emacs-packages"
          git checkout -B "$BRANCH"
          git add "$VERSIONS_FILE"
          git commit -m "bump(emacs): update straight.el package versions"
          git push -f origin "$BRANCH"
          if gh pr view "$BRANCH" --json state -q .state 2>/dev/null | grep -q "OPEN"; then
            echo "PR already exists, updated branch."
          else
            gh pr create \
              --base main \
              --head "$BRANCH" \
              --title "bump(emacs): update straight.el package versions" \
              --body "Automated straight.el package update. Smoke tests passed before creating this PR." \
              --label "dependencies"
          fi
