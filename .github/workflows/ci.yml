# CI Workflow
# This workflow runs linting, type checking, and testing (pytest with coverage),
# builds documentation, and deploys it to GitHub Pages.
name: CI

on:
  workflow_dispatch:
  pull_request:
    paths-ignore:
      - "docs/**"
      - "*.md"
  push:
    branches:
      - main
    paths-ignore:
      - "*.md"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHONUNBUFFERED: "1"
  FORCE_COLOR: "1"

jobs:

  pre-commit:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          cache-dependency-glob: uv.lock
      - name: Sync project with lint deps
        run: uv sync --locked --group lint
      - name: Cache pre-commit
        uses: actions/cache@v5
        with:
          path: /home/runner/.cache/pre-commit/
          key: pre-commit|${{ runner.os }}|${{ hashFiles('.pre-commit-config.yaml') }}
          restore-keys: pre-commit|${{ runner.os }}|
      - name: Run lint
        run: |
          make lint

  test:
    name: Test
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          cache-dependency-glob: uv.lock
      - name: Sync project with test deps
        run: uv sync --locked --group test
      - name: Run tests with coverage
        run: |
          uv run pytest tests/ -v --cov=scripts --cov-report=xml --cov-report=term-missing

  auto_merge_deps:
    name: Auto Merge dependencies labeled PRs
    needs: [pre-commit, test]
    # Run only on pull_request labeled "dependencies"
    if: >
      github.event_name == 'pull_request' &&
      (
      startsWith(github.event.pull_request.title, 'build(pre-commit): update hooks') ||
      contains(github.event.pull_request.labels.*.name, 'dependencies')
      )
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Merge PR
        uses: pascalgn/automerge-action@v0.16.4
        env:
          GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
          MERGE_LABELS: ""
          MERGE_METHOD: squash
          DELETE_BRANCH_AFTER_MERGE: true
          LOG: "TRACE" # or DEBUG
